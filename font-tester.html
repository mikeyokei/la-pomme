<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Pomme Font Tester</title>
    <style>
        /* Font faces - preload for better iOS compatibility */
        @font-face {
            font-family: 'LaPomme-DarumaPomme-Regular';
            src: url('build/instance_ttf/DarumaPomme-Regular.ttf') format('truetype');
            font-display: swap;
        }
        
        @font-face {
            font-family: 'LaPomme-DarumaPomme-Italic';
            src: url('build/instance_ttf/DarumaPomme-Italic.ttf') format('truetype');
            font-display: swap;
        }
        
        @font-face {
            font-family: 'LaPomme-Leafeon-Regular';
            src: url('build/instance_ttf/Leafeon-Regular.ttf') format('truetype');
            font-display: swap;
        }
        
        @font-face {
            font-family: 'LaPomme-Pommiedemo2-Medium';
            src: url('build/instance_ttf/Pommiedemo2-Medium.ttf') format('truetype');
            font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: monospace;
            background: white;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: left;
            margin-bottom: 10px;
            border-bottom: 1px solid black;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 14px;
            font-weight: normal;
            letter-spacing: 1px;
        }

        .toggle-left-panel-btn {
            padding: 3px 8px;
            border: 1px solid black;
            background: white;
            cursor: pointer;
            font-size: 9px;
            font-family: monospace;
            transition: all 0.1s;
        }

        .toggle-left-panel-btn:hover {
            background: black;
            color: white;
        }

        .main-content {
            display: flex;
            gap: 10px;
            flex: 1;
            overflow: hidden;
        }

        .left-panel {
            width: 280px;
            border: 1px solid black;
            padding: 10px;
            overflow-y: auto;
            transition: transform 0.3s ease, opacity 0.3s ease;
            background: white;
        }

        .left-panel.collapsed {
            transform: translateX(-100%);
            opacity: 0;
            width: 0;
            padding: 0;
            border: none;
            overflow: hidden;
        }

        .right-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .controls-panel {
            border: 1px solid black;
            padding: 10px;
            margin-bottom: 10px;
            overflow-y: auto;
            max-height: 40vh;
        }

        .control-group {
            margin-bottom: 10px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            font-size: 10px;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 2px;
            background: black;
            outline: none;
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 8px;
            height: 8px;
            background: white;
            border: 1px solid black;
            cursor: pointer;
        }

        .control-group input[type="range"]::-moz-range-thumb {
            width: 8px;
            height: 8px;
            background: white;
            border: 1px solid black;
            cursor: pointer;
        }

        .control-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .slider-value {
            display: inline-block;
            margin-left: 5px;
            font-size: 10px;
        }

        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .preset-btn {
            padding: 3px 8px;
            border: 1px solid black;
            background: white;
            cursor: pointer;
            font-size: 9px;
            font-family: monospace;
            transition: all 0.1s;
        }

        .preset-btn:hover {
            background: black;
            color: white;
        }

        .download-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .download-btn {
            padding: 5px 10px;
            border: 1px solid black;
            background: white;
            cursor: pointer;
            font-size: 9px;
            font-family: monospace;
            transition: all 0.1s;
            text-decoration: none;
            color: black;
            display: inline-block;
        }

        .download-btn:hover {
            background: black;
            color: white;
        }

        .download-btn:active {
            transform: translateY(1px);
        }

        .version-item {
            border: 1px solid #ddd;
            padding: 8px;
            background: #f9f9f9;
        }

        .version-item-name {
            font-size: 9px;
            font-weight: bold;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        .version-select {
            width: 100%;
            padding: 4px;
            border: 1px solid black;
            background: white;
            font-family: monospace;
            font-size: 9px;
            margin-bottom: 5px;
        }

        .version-download-btn {
            width: 100%;
            padding: 5px;
            border: 1px solid black;
            background: white;
            cursor: pointer;
            font-size: 9px;
            font-family: monospace;
            transition: all 0.1s;
        }

        .version-download-btn:hover {
            background: black;
            color: white;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 3px 0;
            transition: all 0.2s;
        }

        .collapsible-header:hover {
            opacity: 0.7;
        }

        .collapse-toggle {
            font-size: 10px;
            transition: transform 0.2s;
            font-family: monospace;
        }

        .collapse-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 1;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .upload-area {
            margin-top: 5px;
            border: 1px dashed black;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.1s;
        }

        .upload-area:hover {
            background: #f0f0f0;
        }

        .upload-area.dragover {
            background: black;
            color: white;
        }

        .upload-input {
            display: none;
        }

        .upload-label {
            font-size: 9px;
            cursor: pointer;
            display: block;
        }

        .opentype-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 5px;
            margin-top: 5px;
        }

        .ot-feature {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 8px;
        }

        .ot-feature input[type="checkbox"] {
            width: 12px;
            height: 12px;
            cursor: pointer;
        }

        .ot-feature label {
            cursor: pointer;
            margin: 0;
            font-size: 8px;
        }

        .selection-controls {
            margin-top: 5px;
            padding: 8px;
            border: 1px solid #ccc;
            background: #f9f9f9;
            display: none;
        }

        .selection-controls.active {
            display: block;
        }

        .ss-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: 3px;
            margin-top: 5px;
        }

        .ss-btn {
            padding: 3px 5px;
            border: 1px solid black;
            background: white;
            cursor: pointer;
            font-size: 8px;
            font-family: monospace;
            transition: all 0.1s;
        }

        .ss-btn:hover {
            background: black;
            color: white;
        }

        .ss-btn.active {
            background: black;
            color: white;
        }

        .view-toggle {
            display: flex;
            gap: 0;
            margin-top: 5px;
        }

        .view-btn {
            flex: 1;
            padding: 4px;
            border: 1px solid black;
            background: white;
            cursor: pointer;
            font-size: 9px;
            font-family: monospace;
            transition: all 0.1s;
            border-right: none;
        }

        .view-btn:last-child {
            border-right: 1px solid black;
        }

        .view-btn.active {
            background: black;
            color: white;
        }

        .view-btn:hover {
            background: black;
            color: white;
        }

        .test-area {
            background: white;
            border: 1px solid black;
            padding: 40px;
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }

        .custom-text {
            display: none;
            flex: 1;
        }

        .custom-text.active {
            display: flex;
            flex-direction: column;
        }

        #customText {
            font-family: 'LaPomme', sans-serif;
            width: 100%;
            border: none;
            outline: none;
            resize: none;
            flex: 1;
            line-height: 1.5;
            color: black;
            background: transparent;
            padding: 20px;
            overflow: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-variant-ligatures: normal;
            text-rendering: optimizeLegibility;
        }

        .ss-span {
            display: inline;
            cursor: pointer;
        }

        .ss-span:hover {
            background: #f0f0f0;
        }

        .character-grid {
            display: none;
            font-family: 'LaPomme', sans-serif;
        }

        .character-grid.active {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 0;
            padding: 20px;
        }

        .char-box {
            aspect-ratio: 1;
            border: 1px solid black;
            border-right: none;
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            transition: background 0.1s;
            cursor: pointer;
            overflow: visible;
        }

        .char-box:hover {
            background: black;
            color: white;
        }

        .sample-text {
            display: none;
            font-family: 'LaPomme', sans-serif;
            padding: 20px;
        }

        .sample-text.active {
            display: block;
        }

        .sample-section {
            margin-bottom: 30px;
        }

        .sample-section:last-child {
            margin-bottom: 0;
        }

        .sample-section h3 {
            font-family: monospace;
            font-size: 9px;
            margin-bottom: 10px;
            letter-spacing: 1px;
            border-bottom: 1px solid black;
            padding-bottom: 3px;
        }

        .sample-section p {
            margin-bottom: 10px;
            word-wrap: break-word;
            overflow: visible;
        }

        .left-panel .control-group label {
            font-size: 9px;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .left-panel {
                width: 100%;
                max-height: 40vh;
            }

            .left-panel.collapsed {
                max-height: 0;
                transform: translateY(-100%);
            }
            
            .control-row {
                grid-template-columns: 1fr;
            }
            
            .char-box {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>LA POMME FONT TESTER</h1>
            <button class="toggle-left-panel-btn" onclick="toggleLeftPanel()">TOGGLE CONTROLS</button>
        </div>

        <div class="main-content">
            <!-- Left Panel: Typography Controls -->
            <div class="left-panel" id="leftPanel">
                <div class="control-group">
                    <label>MASTER</label>
                    <select id="masterSelect" style="width: 100%; padding: 4px; border: 1px solid black; background: white; font-family: monospace; font-size: 9px;">
                        <option value="">Loading masters...</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>UPLOAD & TEST FONT</label>
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="fontUpload" class="upload-input" accept=".ttf,.otf,.woff,.woff2" multiple>
                        <label for="fontUpload" class="upload-label">
                            CLICK OR DRAG & DROP FONT FILES HERE<br>
                            <span style="font-size: 8px; color: #666;">(TTF, OTF, WOFF, WOFF2)</span>
                        </label>
                    </div>
                </div>

                <div class="control-group">
                    <label>
                        SIZE
                        <span class="slider-value" id="sizeValue">48px</span>
                    </label>
                    <input type="range" id="fontSize" min="12" max="144" value="48" step="1">
                </div>

                <div class="control-group">
                    <label>
                        SPACING
                        <span class="slider-value" id="spacingValue">0em</span>
                    </label>
                    <input type="range" id="letterSpacing" min="-0.1" max="0.5" value="0" step="0.01">
                </div>

                <div class="control-group">
                    <label>
                        LINE HEIGHT
                        <span class="slider-value" id="lineHeightValue">1.5</span>
                    </label>
                    <input type="range" id="lineHeight" min="0.8" max="2.5" value="1.5" step="0.1">
                </div>
            </div>

            <!-- Right Content: Controls & Test Area -->
            <div class="right-content">
                <div class="controls-panel">
                    <div class="control-group">
                        <label>VIEW</label>
                        <div class="view-toggle">
                            <button class="view-btn active" data-view="custom">CUSTOM</button>
                            <button class="view-btn" data-view="samples">SAMPLES</button>
                            <button class="view-btn" data-view="grid">GRID</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>PRESET</label>
                <div class="preset-buttons">
                    <button class="preset-btn" data-text="The quick brown fox jumps over the lazy dog">PANGRAM</button>
                    <button class="preset-btn" data-text="ABCDEFGHIJKLMNOPQRSTUVWXYZ">ABC</button>
                    <button class="preset-btn" data-text="abcdefghijklmnopqrstuvwxyz">abc</button>
                    <button class="preset-btn" data-text="0123456789">123</button>
                    <button class="preset-btn" data-text="!@#$%^&*()_+-=[]{}|;:',.<>?/~`">!@#</button>
                    <button class="preset-btn" data-text="Hamburgefonstiv">BURGER</button>
                </div>
            </div>

            <div class="control-group">
                <div class="collapsible-header" onclick="toggleCollapse('downloadSection')">
                    <label style="margin: 0; cursor: pointer;">DOWNLOAD FONTS</label>
                    <span class="collapse-toggle" id="downloadSection-toggle">‚ñº</span>
                </div>
                <div id="downloadSection" class="collapsible-content collapsed">
                    <div id="downloadButtons" class="download-buttons">
                        <span style="font-size: 9px; color: #666;">Loading available fonts...</span>
                    </div>
                </div>
            </div>

            <div class="control-group" id="versionSelectorGroup" style="display: none;">
                <div class="collapsible-header" onclick="toggleCollapse('versionSection')">
                    <label style="margin: 0; cursor: pointer;">VERSION SELECTOR</label>
                    <span class="collapse-toggle" id="versionSection-toggle">‚ñº</span>
                </div>
                <div id="versionSection" class="collapsible-content collapsed">
                    <div id="versionSelectors" style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                        <!-- Version selectors will be populated here -->
                    </div>
                </div>
            </div>

            <div class="control-group">
                <div class="collapsible-header" onclick="toggleCollapse('opentypeSection')">
                    <label style="margin: 0; cursor: pointer;">OPENTYPE FEATURES</label>
                    <span class="collapse-toggle" id="opentypeSection-toggle">‚ñº</span>
                </div>
                <div id="opentypeSection" class="collapsible-content collapsed">
                    <div class="opentype-grid">
                        <div class="ot-feature">
                            <input type="checkbox" id="liga" checked>
                            <label for="liga">Ligatures</label>
                        </div>
                        <div class="ot-feature">
                            <input type="checkbox" id="calt" checked>
                            <label for="calt">Contextual</label>
                        </div>
                        <div class="ot-feature">
                            <input type="checkbox" id="dlig">
                            <label for="dlig">Discret. Lig</label>
                        </div>
                        <div class="ot-feature">
                            <input type="checkbox" id="swsh">
                            <label for="swsh">Swash</label>
                        </div>
                        <div class="ot-feature">
                            <input type="checkbox" id="smcp">
                            <label for="smcp">Small Caps</label>
                        </div>
                        <div class="ot-feature">
                            <input type="checkbox" id="onum">
                            <label for="onum">Old Style</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <div class="collapsible-header" onclick="toggleCollapse('stylisticSetsSection')">
                    <label style="margin: 0; cursor: pointer;">STYLISTIC SETS (SELECT TEXT FIRST)</label>
                    <span class="collapse-toggle" id="stylisticSetsSection-toggle">‚ñº</span>
                </div>
                <div id="stylisticSetsSection" class="collapsible-content collapsed">
                    <div class="ss-buttons" id="ssButtons">
                        <button class="ss-btn" data-ss="ss01">SS01</button>
                        <button class="ss-btn" data-ss="ss02">SS02</button>
                        <button class="ss-btn" data-ss="ss03">SS03</button>
                        <button class="ss-btn" data-ss="ss04">SS04</button>
                        <button class="ss-btn" data-ss="ss05">SS05</button>
                        <button class="ss-btn" data-ss="ss06">SS06</button>
                        <button class="ss-btn" data-ss="ss07">SS07</button>
                        <button class="ss-btn" data-ss="ss08">SS08</button>
                        <button class="ss-btn" data-ss="ss09">SS09</button>
                        <button class="ss-btn" data-ss="ss10">SS10</button>
                        <button class="ss-btn" data-ss="ss11">SS11</button>
                        <button class="ss-btn" data-ss="ss12">SS12</button>
                        <button class="ss-btn" data-ss="ss13">SS13</button>
                        <button class="ss-btn" data-ss="ss14">SS14</button>
                        <button class="ss-btn" data-ss="ss15">SS15</button>
                        <button class="ss-btn" data-ss="ss16">SS16</button>
                        <button class="ss-btn" data-ss="ss17">SS17</button>
                        <button class="ss-btn" data-ss="ss18">SS18</button>
                        <button class="ss-btn" data-ss="ss19">SS19</button>
                        <button class="ss-btn" data-ss="ss20">SS20</button>
                    </div>
                    <div style="margin-top: 5px; font-size: 8px; color: #666;">
                        <strong>Apply:</strong> Select text, click SS button<br>
                        <strong>Remove:</strong> Select styled text (hover shows gray), click any SS button OR click the styled text<br>
                        <button id="clearAllSS" style="margin-top: 5px; padding: 3px 8px; border: 1px solid black; background: white; cursor: pointer; font-size: 8px; font-family: monospace;">Clear All SS</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="test-area">
            <!-- Custom Text View -->
            <div id="customView" class="custom-text active">
                <div id="customText" contenteditable="true" spellcheck="false">The quick brown fox jumps over the lazy dog
ABCDEFGHIJKLMNOPQRSTUVWXYZ
abcdefghijklmnopqrstuvwxyz
0123456789</div>
            </div>

            <!-- Sample Text View -->
            <div id="samplesView" class="sample-text">
                <div class="sample-section">
                    <h3>PANGRAMS</h3>
                    <p>The quick brown fox jumps over the lazy dog</p>
                    <p>Pack my box with five dozen liquor jugs</p>
                    <p>Sphinx of black quartz, judge my vow</p>
                    <p>How vexingly quick daft zebras jump!</p>
                </div>

                <div class="sample-section">
                    <h3>ALPHABET</h3>
                    <p>ABCDEFGHIJKLMNOPQRSTUVWXYZ</p>
                    <p>abcdefghijklmnopqrstuvwxyz</p>
                </div>

                <div class="sample-section">
                    <h3>NUMBERS & SYMBOLS</h3>
                    <p>0123456789</p>
                    <p>!@#$%^&*()_+-=[]{}|;:',.<>?/~`</p>
                </div>

                <div class="sample-section">
                    <h3>COMMON WORDS</h3>
                    <p>Typography Design Font Geometric Modern Elegant</p>
                    <p>Hamburgefonstiv ‚Ä¢ Handgloves ‚Ä¢ HVOPW avopw</p>
                </div>

                <div class="sample-section">
                    <h3>PARAGRAPH</h3>
                    <p>Typography is the art and technique of arranging type to make written language legible, readable and appealing when displayed. The arrangement of type involves selecting typefaces, point sizes, line lengths, line-spacing, and letter-spacing, and adjusting the space between pairs of letters.</p>
                </div>
            </div>

            <!-- Character Grid View -->
            <div id="gridView" class="character-grid">
                <!-- JavaScript will populate this -->
            </div>
        </div>
            </div>
        </div>
    </div>

    <script>
        // Font controls
        const fontSize = document.getElementById('fontSize');
        const letterSpacing = document.getElementById('letterSpacing');
        const lineHeight = document.getElementById('lineHeight');
        const customText = document.getElementById('customText');
        const sizeValue = document.getElementById('sizeValue');
        const spacingValue = document.getElementById('spacingValue');
        const lineHeightValue = document.getElementById('lineHeightValue');
        const masterSelect = document.getElementById('masterSelect');

        // View controls
        const viewButtons = document.querySelectorAll('.view-btn');
        const customView = document.getElementById('customView');
        const samplesView = document.getElementById('samplesView');
        const gridView = document.getElementById('gridView');

        // Preset buttons
        const presetButtons = document.querySelectorAll('.preset-btn');

        // Available masters - will be populated dynamically
        let currentMaster = null;
        let loadedFonts = {};
        let uploadedFonts = [];

        // View switching
        viewButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Update active button
                viewButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                // Show corresponding view
                const view = button.dataset.view;
                customView.classList.remove('active');
                samplesView.classList.remove('active');
                gridView.classList.remove('active');

                if (view === 'custom') {
                    customView.classList.add('active');
                } else if (view === 'samples') {
                    samplesView.classList.add('active');
                } else if (view === 'grid') {
                    gridView.classList.add('active');
                }
            });
        });

        // Preset text buttons
        presetButtons.forEach(button => {
            button.addEventListener('click', () => {
                customText.textContent = button.dataset.text;
                // Switch to custom view
                viewButtons[0].click();
            });
        });

        // OpenType feature toggles
        const otFeatures = ['liga', 'calt', 'dlig', 'swsh', 'smcp', 'onum'];
        const activeFeatures = new Set(['liga', 'calt']); // Default active features

        otFeatures.forEach(feature => {
            const checkbox = document.getElementById(feature);
            if (checkbox) {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        activeFeatures.add(feature);
                    } else {
                        activeFeatures.delete(feature);
                    }
                    applyOpenTypeFeatures();
                });
            }
        });

        function applyOpenTypeFeatures() {
            const featureString = Array.from(activeFeatures)
                .map(f => `"${f}" 1`)
                .join(', ');
            
            // Apply font-feature-settings
            customText.style.fontFeatureSettings = featureString || 'normal';
            samplesView.style.fontFeatureSettings = featureString || 'normal';
            gridView.style.fontFeatureSettings = featureString || 'normal';
            
            // Special handling for ligatures with font-variant-ligatures
            if (activeFeatures.has('liga')) {
                customText.style.fontVariantLigatures = 'common-ligatures';
                samplesView.style.fontVariantLigatures = 'common-ligatures';
                gridView.style.fontVariantLigatures = 'common-ligatures';
            } else {
                customText.style.fontVariantLigatures = 'no-common-ligatures';
                samplesView.style.fontVariantLigatures = 'no-common-ligatures';
                gridView.style.fontVariantLigatures = 'no-common-ligatures';
            }
            
            console.log('Applied OpenType features:', featureString);
        }

        // Detect available stylistic sets in the current font
        async function detectAvailableStylisticSets() {
            if (!currentMaster || !loadedFonts[currentMaster]) {
                return [];
            }

            const availableSets = [];
            const testText = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
            
            // Test each stylistic set
            for (let i = 1; i <= 20; i++) {
                const ssName = `ss${String(i).padStart(2, '0')}`;
                
                try {
                    // Create a test element
                    const testEl = document.createElement('span');
                    testEl.style.fontFamily = loadedFonts[currentMaster];
                    testEl.style.fontFeatureSettings = `"${ssName}" 1`;
                    testEl.textContent = testText;
                    testEl.style.position = 'absolute';
                    testEl.style.visibility = 'hidden';
                    document.body.appendChild(testEl);
                    
                    // If the feature exists, add it
                    // Note: This is a simple check - in production you'd want more sophisticated detection
                    availableSets.push(ssName);
                    
                    document.body.removeChild(testEl);
                } catch (e) {
                    // Feature not available
                }
            }
            
            return availableSets;
        }

        // Update stylistic set buttons based on available features
        async function updateStylisticSetButtons() {
            const ssButtonsContainer = document.getElementById('ssButtons');
            const availableSets = await detectAvailableStylisticSets();
            
            // For now, show all 20 buttons (proper detection requires font parsing which is complex)
            // But we'll make them toggleable and show feedback
            const allButtons = ssButtonsContainer.querySelectorAll('.ss-btn');
            allButtons.forEach(btn => {
                btn.style.display = 'inline-block';
            });
            
            console.log('Stylistic set buttons ready');
        }

        // Stylistic Sets for selected text
        const ssButtons = document.querySelectorAll('.ss-btn');
        
        ssButtons.forEach(button => {
            button.addEventListener('click', function() {
                const ssFeature = this.dataset.ss;
                applyStylisticSetToSelection(ssFeature);
            });
        });

        function applyStylisticSetToSelection(ssFeature) {
            const selection = window.getSelection();
            
            if (!selection.rangeCount || selection.isCollapsed) {
                alert('Please select some text first!\n\nTip: You can also click on already styled text (with gray background on hover) to remove the stylistic set.');
                return;
            }

            const range = selection.getRangeAt(0);
            
            // Check if selection is within customText
            let container = range.commonAncestorContainer;
            if (container.nodeType === Node.TEXT_NODE) {
                container = container.parentNode;
            }
            
            if (!customText.contains(container)) {
                alert('Please select text in the editor!');
                return;
            }

            // Check if the selection is within an existing ss-span
            let existingSpan = container;
            while (existingSpan && existingSpan !== customText) {
                if (existingSpan.classList && existingSpan.classList.contains('ss-span')) {
                    // Remove the stylistic set by unwrapping the span
                    const parent = existingSpan.parentNode;
                    while (existingSpan.firstChild) {
                        parent.insertBefore(existingSpan.firstChild, existingSpan);
                    }
                    parent.removeChild(existingSpan);
                    console.log(`Removed stylistic set from text`);
                    selection.removeAllRanges();
                    return;
                }
                existingSpan = existingSpan.parentNode;
            }

            // Extract the selected content
            const selectedContent = range.extractContents();
            
            // Create a span with the stylistic set
            const span = document.createElement('span');
            span.className = 'ss-span';
            span.style.fontFeatureSettings = `"${ssFeature}" 1`;
            span.title = `Stylistic Set: ${ssFeature.toUpperCase()} (select and click any SS button to remove)`;
            span.appendChild(selectedContent);
            
            // Add click event to remove the stylistic set
            span.addEventListener('click', function(e) {
                e.stopPropagation();
                const parent = this.parentNode;
                while (this.firstChild) {
                    parent.insertBefore(this.firstChild, this);
                }
                parent.removeChild(this);
                console.log(`Removed stylistic set by clicking`);
            });
            
            // Insert the span
            range.insertNode(span);
            
            // Clear selection
            selection.removeAllRanges();
            
            console.log(`Applied ${ssFeature} to selected text`);
        }

        // Generate character grid
        function generateCharacterGrid() {
            const chars = [];
            
            // Basic Latin uppercase
            for (let i = 65; i <= 90; i++) {
                chars.push(String.fromCharCode(i));
            }
            
            // Basic Latin lowercase
            for (let i = 97; i <= 122; i++) {
                chars.push(String.fromCharCode(i));
            }
            
            // Numbers
            for (let i = 48; i <= 57; i++) {
                chars.push(String.fromCharCode(i));
            }
            
            // Common punctuation and symbols
            const symbols = '!@#$%^&*()_+-=[]{}|;:\',.<>?/~`"\\';
            chars.push(...symbols.split(''));
            
            // Extended Latin (common accented characters)
            const extended = '√Ä√Å√Ç√É√Ñ√Ö√Ü√á√à√â√ä√ã√å√ç√é√è√ê√ë√í√ì√î√ï√ñ√ò√ô√ö√õ√ú√ù√û√ü√†√°√¢√£√§√•√¶√ß√®√©√™√´√¨√≠√Æ√Ø√∞√±√≤√≥√¥√µ√∂√∏√π√∫√ª√º√Ω√æ√ø';
            chars.push(...extended.split(''));

            gridView.innerHTML = chars.map(char => 
                `<div class="char-box" title="${char}">${char}</div>`
            ).join('');
        }

        // Load available masters from build directory
        async function loadAvailableMasters() {
            const possibleMasters = [
                { file: 'DarumaPomme-Regular.ttf', name: 'JARDIN (REGULAR)', fontFamily: 'LaPomme-DarumaPomme-Regular' },
                { file: 'DarumaPomme-Italic.ttf', name: 'JARDIN (ITALIC)', fontFamily: 'LaPomme-DarumaPomme-Italic' },
                { file: 'Leafeon-Regular.ttf', name: 'LEAFEON', fontFamily: 'LaPomme-Leafeon-Regular' },
                { file: 'Pommiedemo2-Medium.ttf', name: 'POMMIE', fontFamily: 'LaPomme-Pommiedemo2-Medium' }
            ];

            const availableMasters = [];
            
            console.log('üîç Loading fonts from:', window.location.origin);
            console.log('üì± Device:', navigator.userAgent);
            
            // Wait for fonts to load (they're defined in CSS @font-face)
            // This works better on iOS than using FontFace API
            if (document.fonts && document.fonts.ready) {
                try {
                    await document.fonts.ready;
                    console.log('‚úÖ Document fonts ready');
                } catch (e) {
                    console.warn('Fonts.ready failed:', e);
                }
            }
            
            // Check each font and add to available list
            for (const master of possibleMasters) {
                try {
                    // Check if font is available using CSS @font-face
                    const testText = 'abcdefghijklmnopqrstuvwxyz';
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Test with fallback font
                    ctx.font = '72px monospace';
                    const fallbackWidth = ctx.measureText(testText).width;
                    
                    // Test with our font
                    ctx.font = `72px "${master.fontFamily}", monospace`;
                    const testWidth = ctx.measureText(testText).width;
                    
                    // If widths are different, font loaded successfully
                    if (Math.abs(testWidth - fallbackWidth) > 1) {
                        availableMasters.push(master);
                        loadedFonts[master.file] = master.fontFamily;
                        console.log(`‚úÖ Loaded: ${master.name} (${master.fontFamily})`);
                    } else {
                        // Font might still be loading, add it anyway (CSS will handle it)
                        availableMasters.push(master);
                        loadedFonts[master.file] = master.fontFamily;
                        console.log(`‚è≥ Added: ${master.name} (loading...)`);
                    }
                } catch (e) {
                    console.error(`‚ùå Error checking ${master.name}:`, e);
                    // Add it anyway - CSS will handle loading
                    availableMasters.push(master);
                    loadedFonts[master.file] = master.fontFamily;
                }
            }

            if (availableMasters.length === 0) {
                masterSelect.innerHTML = '<option value="">‚ö†Ô∏è No fonts loaded - Check console</option>';
                console.error('‚ùå FONT LOADING FAILED');
                console.error('Current URL:', window.location.href);
                return;
            }

            // Populate the dropdown
            masterSelect.innerHTML = availableMasters.map(master => {
                return `<option value="${master.file}">${master.name}</option>`;
            }).join('');

            // Set and apply the first master
            if (availableMasters.length > 0) {
                currentMaster = availableMasters[0].file;
                masterSelect.value = currentMaster;
                applyStyles();
                console.log(`‚úÖ Loaded ${availableMasters.length} fonts successfully!`);
            }
        }

        // Master selection change
        masterSelect.addEventListener('change', (e) => {
            const selectedMaster = e.target.value;
            if (selectedMaster && loadedFonts[selectedMaster]) {
                currentMaster = selectedMaster;
                applyStyles();
                console.log(`Switched to: ${selectedMaster}`);
            }
        });

        // Apply font styles (updated to use current master)
        function applyStyles() {
            const size = fontSize.value + 'px';
            const spacing = letterSpacing.value + 'em';
            const lh = lineHeight.value;

            if (currentMaster && loadedFonts[currentMaster]) {
                const fontName = loadedFonts[currentMaster];
                customText.style.fontFamily = `'${fontName}', monospace`;
                samplesView.style.fontFamily = `'${fontName}', monospace`;
                gridView.style.fontFamily = `'${fontName}', monospace`;
            }

            customText.style.fontSize = size;
            customText.style.letterSpacing = spacing;
            customText.style.lineHeight = lh;

            samplesView.style.fontSize = size;
            samplesView.style.letterSpacing = spacing;
            samplesView.style.lineHeight = lh;

            gridView.style.fontSize = size;
            gridView.style.letterSpacing = spacing;

            sizeValue.textContent = size;
            spacingValue.textContent = spacing;
            lineHeightValue.textContent = lh;
        }

        // Event listeners for sliders
        fontSize.addEventListener('input', applyStyles);
        letterSpacing.addEventListener('input', applyStyles);
        lineHeight.addEventListener('input', applyStyles);

        // Font upload functionality
        const uploadArea = document.getElementById('uploadArea');
        const fontUpload = document.getElementById('fontUpload');

        // Handle file selection via input
        fontUpload.addEventListener('change', function(e) {
            handleFontFiles(e.target.files);
        });

        // Drag and drop handlers
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');
            handleFontFiles(e.dataTransfer.files);
        });

        // Handle uploaded font files
        async function handleFontFiles(files) {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileName = file.name;
                const fileExt = fileName.split('.').pop().toLowerCase();

                // Check if it's a valid font file
                if (!['ttf', 'otf', 'woff', 'woff2'].includes(fileExt)) {
                    console.log(`‚è≠Ô∏è Skipped: ${fileName} - not a valid font file`);
                    continue;
                }

                try {
                    // Read the file as a data URL
                    const reader = new FileReader();
                    
                    reader.onload = async function(e) {
                        const fontData = e.target.result;
                        const fontName = `Uploaded-${fileName.replace(/\.[^/.]+$/, '')}`;
                        
                        try {
                            // Create and load the font
                            const fontFace = new FontFace(fontName, `url(${fontData})`);
                            await fontFace.load();
                            document.fonts.add(fontFace);
                            
                            // Add to uploaded fonts list
                            const fontKey = `uploaded_${uploadedFonts.length}`;
                            uploadedFonts.push({
                                key: fontKey,
                                name: fontName,
                                displayName: fileName
                            });
                            loadedFonts[fontKey] = fontName;
                            
                            // Add to master selector
                            const option = document.createElement('option');
                            option.value = fontKey;
                            option.textContent = `üì§ ${fileName}`;
                            masterSelect.appendChild(option);
                            
                            // Automatically switch to the uploaded font
                            currentMaster = fontKey;
                            masterSelect.value = fontKey;
                            applyStyles();
                            
                            console.log(`‚úÖ Loaded uploaded font: ${fileName}`);
                        } catch (error) {
                            console.error(`‚ùå Error loading font ${fileName}:`, error);
                            alert(`Failed to load font: ${fileName}\n${error.message}`);
                        }
                    };
                    
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error(`‚ùå Error reading file ${fileName}:`, error);
                }
            }
        }

        // Load and generate download buttons for available fonts
        async function loadDownloadButtons() {
            const downloadContainer = document.getElementById('downloadButtons');
            const versionSelectorGroup = document.getElementById('versionSelectorGroup');
            const versionSelectors = document.getElementById('versionSelectors');
            
            try {
                // Try to load versions.json
                const response = await fetch('build/versions.json');
                if (response.ok) {
                    const versions = await response.json();
                    
                    // Display quick download buttons for latest versions
                    downloadContainer.innerHTML = '<div style="font-size: 9px; margin-bottom: 5px;">LATEST VERSIONS:</div>';
                    
                    const fontDisplayNames = {
                        'DarumaPomme-Regular': 'Jardin Regular',
                        'DarumaPomme-Italic': 'Jardin Italic',
                        'Leafeon-Regular': 'Leafeon',
                        'Pommiedemo2-Medium': 'Pommie'
                    };
                    
                    // Create download buttons for latest versions
                    for (const [baseName, versionList] of Object.entries(versions)) {
                        if (versionList.length > 0) {
                            const latest = versionList[0]; // First item is most recent
                            const displayName = fontDisplayNames[baseName] || baseName;
                            
                            const button = document.createElement('a');
                            button.href = latest.path;
                            button.download = latest.filename;
                            button.className = 'download-btn';
                            button.textContent = `‚Üì ${displayName}`;
                            downloadContainer.appendChild(button);
                        }
                    }
                    
                    // Create version selectors
                    versionSelectors.innerHTML = '';
                    for (const [baseName, versionList] of Object.entries(versions)) {
                        if (versionList.length > 0) {
                            const displayName = fontDisplayNames[baseName] || baseName;
                            
                            const versionItem = document.createElement('div');
                            versionItem.className = 'version-item';
                            
                            const nameLabel = document.createElement('div');
                            nameLabel.className = 'version-item-name';
                            nameLabel.textContent = displayName.toUpperCase();
                            versionItem.appendChild(nameLabel);
                            
                            // Create select dropdown
                            const select = document.createElement('select');
                            select.className = 'version-select';
                            select.dataset.baseName = baseName;
                            
                            versionList.forEach((version, index) => {
                                const option = document.createElement('option');
                                option.value = index;
                                option.textContent = version.date + (index === 0 ? ' (Latest)' : '');
                                option.dataset.path = version.path;
                                option.dataset.filename = version.filename;
                                select.appendChild(option);
                            });
                            
                            versionItem.appendChild(select);
                            
                            // Create download button
                            const downloadBtn = document.createElement('button');
                            downloadBtn.className = 'version-download-btn';
                            downloadBtn.textContent = '‚Üì Download Selected Version';
                            downloadBtn.onclick = function() {
                                const selectedOption = select.options[select.selectedIndex];
                                const path = selectedOption.dataset.path;
                                const filename = selectedOption.dataset.filename;
                                
                                // Create temporary link and trigger download
                                const a = document.createElement('a');
                                a.href = path;
                                a.download = filename;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                            };
                            
                            versionItem.appendChild(downloadBtn);
                            versionSelectors.appendChild(versionItem);
                        }
                    }
                    
                    // Show version selector group
                    versionSelectorGroup.style.display = 'block';
                    
                    console.log(`‚úÖ Loaded versions for ${Object.keys(versions).length} font(s)`);
                } else {
                    // versions.json not found, fall back to simple method
                    console.log('‚ö†Ô∏è versions.json not found, using fallback method');
                    await loadDownloadButtonsFallback();
                }
            } catch (e) {
                console.error('Error loading versions:', e);
                await loadDownloadButtonsFallback();
            }
        }
        
        // Fallback method for loading fonts without versions.json
        async function loadDownloadButtonsFallback() {
            const downloadContainer = document.getElementById('downloadButtons');
            
            // List of all potential font files (latest versions)
            const potentialFonts = [
                { path: 'build/instance_ttf/DarumaPomme-Regular.ttf', name: 'Jardin Regular', format: 'TTF' },
                { path: 'build/instance_ttf/DarumaPomme-Italic.ttf', name: 'Jardin Italic', format: 'TTF' },
                { path: 'build/instance_ttf/Leafeon-Regular.ttf', name: 'Leafeon', format: 'TTF' },
                { path: 'build/instance_ttf/Pommiedemo2-Medium.ttf', name: 'Pommie', format: 'TTF' }
            ];

            const availableFonts = [];
            
            // Check which fonts actually exist by trying to load them
            for (const font of potentialFonts) {
                try {
                    const testFont = new FontFace(`Test-${font.name}`, `url(${font.path})`);
                    await testFont.load();
                    availableFonts.push(font);
                    console.log(`‚úÖ Found: ${font.name} (${font.format})`);
                } catch (e) {
                    console.log(`‚è≠Ô∏è Skipped: ${font.name} (${font.format}) - not found`);
                }
            }

            // Generate download buttons only for available fonts
            if (availableFonts.length === 0) {
                downloadContainer.innerHTML = '<span style="font-size: 9px; color: #666;">No fonts available for download</span>';
            } else {
                downloadContainer.innerHTML = '';
                availableFonts.forEach(font => {
                    const button = document.createElement('a');
                    button.href = font.path;
                    button.download = font.path.split('/').pop();
                    button.className = 'download-btn';
                    button.textContent = `‚Üì ${font.name} (${font.format})`;
                    downloadContainer.appendChild(button);
                });
                console.log(`‚úÖ Generated ${availableFonts.length} download buttons`);
            }
        }

        // Clear all stylistic sets button
        document.getElementById('clearAllSS').addEventListener('click', function() {
            const allSpans = customText.querySelectorAll('.ss-span');
            allSpans.forEach(span => {
                const parent = span.parentNode;
                while (span.firstChild) {
                    parent.insertBefore(span.firstChild, span);
                }
                parent.removeChild(span);
            });
            console.log(`Cleared all stylistic sets (${allSpans.length} removed)`);
        });

        // Toggle collapse for sections
        function toggleCollapse(sectionId) {
            const content = document.getElementById(sectionId);
            const toggle = document.getElementById(sectionId + '-toggle');
            
            if (content && toggle) {
                content.classList.toggle('collapsed');
                toggle.classList.toggle('collapsed');
            }
        }

        // Toggle left panel
        function toggleLeftPanel() {
            const leftPanel = document.getElementById('leftPanel');
            if (leftPanel) {
                leftPanel.classList.toggle('collapsed');
            }
        }

        // Initialize
        applyStyles();
        applyOpenTypeFeatures(); // Apply default OpenType features
        generateCharacterGrid();
        loadAvailableMasters();
        loadDownloadButtons();
    </script>
</body>
</html>

